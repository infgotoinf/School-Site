from fastapi import FastAPI, Form
from fastapi.staticfiles import StaticFiles
from fastapi.responses import HTMLResponse, FileResponse

import requests
import json
import os

from tkinter import filedialog

from encrypt import xor_encrypt_decrypt

root = os.path.dirname(os.path.abspath(__file__))
key = "69"

# –ó–∞–≥—Ä—É–∑–∫–∞ jsona —Å –≥–∏—Ç—Ö–∞–±–∞ –≤ –ø–µ—Ä–µ–º–µ–Ω–Ω—É—é
response = requests.get("https://raw.githubusercontent.com/infgotoinf/School-Site/refs/heads/main/files/jsons/data.json")
data = response.content.decode('utf-8') # –î–µ–∫–æ–¥–∏—Ä—É–µ–º –¥–∞–Ω–Ω—ã–µ
user_data = json.loads(data) # –ü–æ–ª—É—á–∞–µ–º JSON. üòé
# –†–∞—Å—à–∏—Ñ—Ä–æ–≤—ã–≤–∞–µ–º
for js in user_data:
    for j in js:
        js[j] = xor_encrypt_decrypt(js[j], key)
    print()

response = requests.get("https://raw.githubusercontent.com/infgotoinf/School-Site/refs/heads/main/files/jsons/materials.json")
data = response.content.decode('utf-8')
material_data = json.loads(data)


app = FastAPI()

# –ì–æ–≤–æ—Ä–∏–º –ê–ü–ò –≥–¥–µ –Ω–∞—Ö–æ–¥—è—Ç—Å—è —Å—Ç–∞—Ç–∏–∫ —Ñ–∞–π–ª—ã
app.mount('/static', StaticFiles(directory='static'), 'static')


@app.get("/")
def root():
    return FileResponse("site/index.html")

@app.post("/login")
def postdata(login = Form(), password=Form()):
    for i in user_data:
        if ((i["login"] == login) & (i["password"] == password)):
            return FileResponse("site/menu.html")
    return FileResponse("site/index.html")

@app.get("/tables")
def root():
    return FileResponse("site/tables.html")

@app.get("/materials", response_class=HTMLResponse)
def root():
    data = "<h1>–ú–∞—Ç–µ—Ä–∏–∞–ª—ã</h1>"
    data = data + f'<button action="login" class="add" method="post">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button><br>'
    for i in material_data:
        file = i["filename"]
        data = data + f'<a href="https://github.com/infgotoinf/School-Site/raw/refs/heads/main/files/materials/{file}">{file}</a>'
        data = data + f'<button id="{file}" class="delete">–£–¥–∞–ª–∏—Ç—å</button><br>'
    return data

@app.post("/materials/add")
def add():
    File = filedialog.askopenfilename()
    # print(File)

    if (File != ''):
        i = len(File) - 1
        Filename = ''
        while (File[i] != '/'):
            Filename = File[i] + Filename
            i -= 1
        # print(Filename)
    return data

# for js in user_data:
#     for j in js:
#         js[j] = xor_encrypt_decrypt(js[j], key)
#     print()

# with open('data.json', 'w', encoding='utf-8') as file:
#     json.dump(user_data, file, ensure_ascii=False, indent=4)